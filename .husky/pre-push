#!/usr/bin/env bash
set -o pipefail

LOG_DIR=".logs"
mkdir -p "$LOG_DIR"
LOG_FILE="$LOG_DIR/pre-push-$(date +%Y%m%d-%H%M%S).log"

run_and_log() {
  echo ">> $*" | tee -a "$LOG_FILE"
  "$@" 2>&1 | tee -a "$LOG_FILE"
  return ${PIPESTATUS[0]}
}

echo "ğŸš€ Pre-Push Validation" | tee -a "$LOG_FILE"
echo "=======================" | tee -a "$LOG_FILE"

current_branch=$(git symbolic-ref --short HEAD)
echo "ğŸ“ Current branch: $current_branch" | tee -a "$LOG_FILE"

# Protect main/master
if [ "$current_branch" = "main" ] || [ "$current_branch" = "master" ]; then
  echo "âš ï¸  You're pushing to $current_branch!" | tee -a "$LOG_FILE"
  echo "ğŸ¤” Continue? This should usually be via Pull Request. (y/N)" | tee -a "$LOG_FILE"
  read -r response
  if [ "$response" != "y" ] && [ "$response" != "Y" ]; then
    echo "âŒ Push cancelled for safety." | tee -a "$LOG_FILE"
    echo "Log saved to $LOG_FILE" | tee -a "$LOG_FILE"
    exit 1
  fi
fi

echo "ğŸ§ª Running validate (lint + build)..." | tee -a "$LOG_FILE"
run_and_log yarn validate
if [ $? -ne 0 ]; then
  echo "âŒ Validation failed! Cannot push broken code. See $LOG_FILE" | tee -a "$LOG_FILE"
  exit 1
fi

echo "ğŸ§¹ Cleaning up build artifacts..." | tee -a "$LOG_FILE"
run_and_log rm -rf dist

echo "âœ… Pre-push validation complete!" | tee -a "$LOG_FILE"
echo "ğŸš€ Safe to push to $current_branch" | tee -a "$LOG_FILE"
echo "Log saved to $LOG_FILE" | tee -a "$LOG_FILE"
echo "=======================" | tee -a "$LOG_FILE"
